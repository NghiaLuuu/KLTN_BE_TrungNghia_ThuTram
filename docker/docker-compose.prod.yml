version: '3.8'

# Production overrides for secure deployment
services:
  # Infrastructure services - bind to localhost only for security
  mongodb:
    ports:
      - "127.0.0.1:27017:27017"  # Only localhost access
    restart: always
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    ports:
      - "127.0.0.1:6379:6379"  # Only localhost access
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  rabbitmq:
    ports:
      - "127.0.0.1:5672:5672"
      - "127.0.0.1:15672:15672"  # Management UI - localhost only
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.2'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Microservices - bind to localhost, use reverse proxy
  auth-service:
    ports:
      - "127.0.0.1:3001:3001"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  room-service:
    ports:
      - "127.0.0.1:3002:3002"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  service-service:
    ports:
      - "127.0.0.1:3003:3003"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  schedule-service:
    ports:
      - "127.0.0.1:3005:3005"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  appointment-service:
    ports:
      - "127.0.0.1:3006:3006"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  payment-service:
    ports:
      - "127.0.0.1:3007:3007"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  invoice-service:
    ports:
      - "127.0.0.1:3008:3008"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  medicine-service:
    ports:
      - "127.0.0.1:3009:3009"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  record-service:
    ports:
      - "127.0.0.1:3010:3010"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  statistic-service:
    ports:
      - "127.0.0.1:3011:3011"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  chat-service:
    ports:
      - "127.0.0.1:3012:3012"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  chatbot-service:
    ports:
      - "127.0.0.1:3013:3013"
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=256
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx Reverse Proxy (RECOMMENDED for production)
  nginx:
    image: nginx:alpine
    container_name: dental_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - auth-service
      - room-service
      - service-service
      - schedule-service
      - appointment-service
      - payment-service
      - invoice-service
      - medicine-service
      - record-service
      - statistic-service
      - chat-service
      - chatbot-service
    networks:
      - dental-network
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"