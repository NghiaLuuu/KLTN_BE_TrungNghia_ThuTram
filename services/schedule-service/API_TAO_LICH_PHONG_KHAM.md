# üìÖ API T·∫†O L·ªäCH L√ÄM VI·ªÜC CHO PH√íNG KH√ÅM

## üéØ T·ªïng quan

API `POST /api/schedules/room/generate` ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ **t·∫°o l·ªãch l√†m vi·ªác** cho c√°c ph√≤ng kh√°m trong h·ªá th·ªëng SmileCare Dental Clinic. API n√†y h·ªó tr·ª£ t·∫°o l·ªãch theo th√°ng v·ªõi nhi·ªÅu t√≠nh nƒÉng linh ho·∫°t.

---

## üìç Endpoint

```
POST /api/schedules/room/generate
```

**Authorization:** Y√™u c·∫ßu token c·ªßa `manager` ho·∫∑c `admin`

---

## üì• Request Body

### C√°c tham s·ªë b·∫Øt bu·ªôc:

| Tham s·ªë | Ki·ªÉu | M√¥ t·∫£ |
|---------|------|-------|
| `roomId` | String | ID c·ªßa ph√≤ng kh√°m c·∫ßn t·∫°o l·ªãch |
| `fromMonth` | Number (1-12) | Th√°ng b·∫Øt ƒë·∫ßu |
| `toMonth` | Number (1-12) | Th√°ng k·∫øt th√∫c |
| `fromYear` | Number | NƒÉm b·∫Øt ƒë·∫ßu |
| `toYear` | Number | NƒÉm k·∫øt th√∫c |
| `startDate` | ISO Date String | Ng√†y b·∫Øt ƒë·∫ßu t·∫°o l·ªãch (cho th√°ng ƒë·∫ßu ti√™n) |
| `shifts` | Array[String] | C√°c ca ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ t·∫°o: `['morning', 'afternoon', 'evening']` |

### C√°c tham s·ªë t√πy ch·ªçn:

| Tham s·ªë | Ki·ªÉu | M√¥ t·∫£ |
|---------|------|-------|
| `subRoomId` | String | ID c·ªßa bu·ªìng (d√πng cho ph√≤ng c√≥ nhi·ªÅu bu·ªìng) - **Legacy** |
| `selectedSubRoomIds` | Array[String] | Danh s√°ch ID c√°c bu·ªìng ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ sinh slots |
| `partialStartDate` | ISO Date String | Ng√†y b·∫Øt ƒë·∫ßu t·∫°o l·ªãch (d√πng khi th√™m ca thi·∫øu) |
| `year` | Number | NƒÉm (deprecated - d√πng `fromYear`/`toYear`) |

---

## üì§ Response

### Success Response (201 Created):

```json
{
  "success": true,
  "message": "T·∫°o l·ªãch th√†nh c√¥ng",
  "data": {
    "results": [
      {
        "month": 1,
        "year": 2025,
        "status": "created",
        "scheduleId": "schedule_id_123",
        "totalSlots": 240,
        "slotsByShift": {
          "morning": 80,
          "afternoon": 80,
          "evening": 80
        }
      },
      {
        "month": 2,
        "year": 2025,
        "status": "created",
        "scheduleId": "schedule_id_456",
        "totalSlots": 240,
        "slotsByShift": {
          "morning": 80,
          "afternoon": 80,
          "evening": 80
        }
      }
    ],
    "totalMonths": 2,
    "totalSlots": 480,
    "message": "ƒê√£ t·∫°o l·ªãch th√†nh c√¥ng cho 2 th√°ng v·ªõi t·ªïng c·ªông 480 slots"
  }
}
```

### Error Response (400/403/500):

```json
{
  "success": false,
  "message": "L·ªói c·ª• th·ªÉ ·ªü ƒë√¢y"
}
```

---

## üîß C√°ch ho·∫°t ƒë·ªông

### 1. **Validation ƒë·∫ßu v√†o**

API s·∫Ω ki·ªÉm tra:
- ‚úÖ `roomId`, `fromMonth`, `toMonth`, `fromYear`, `toYear`, `startDate`, `shifts` ph·∫£i c√≥ ƒë·∫ßy ƒë·ªß
- ‚úÖ Th√°ng ph·∫£i t·ª´ 1-12
- ‚úÖ NƒÉm k·∫øt th√∫c >= NƒÉm b·∫Øt ƒë·∫ßu
- ‚úÖ N·∫øu c√πng nƒÉm: Th√°ng k·∫øt th√∫c >= Th√°ng b·∫Øt ƒë·∫ßu
- ‚úÖ Ph·∫£i ch·ªçn √≠t nh·∫•t 1 ca (`shifts.length > 0`)
- ‚úÖ Ca ch·ªâ ƒë∆∞·ª£c l√†: `'morning'`, `'afternoon'`, `'evening'`
- ‚úÖ `selectedSubRoomIds` ph·∫£i l√† m·∫£ng (n·∫øu c√≥)
- ‚úÖ `partialStartDate` ph·∫£i sau ng√†y hi·ªán t·∫°i √≠t nh·∫•t 1 ng√†y (n·∫øu c√≥)

### 2. **X√°c ƒë·ªãnh c√°c th√°ng c·∫ßn t·∫°o**

API s·∫Ω t√≠nh to√°n t·∫•t c·∫£ c√°c th√°ng t·ª´ `fromMonth/fromYear` ƒë·∫øn `toMonth/toYear`:

**V√≠ d·ª• 1:** C√πng nƒÉm
```
fromMonth: 1, toMonth: 3, fromYear: 2025, toYear: 2025
‚Üí T·∫°o: 1/2025, 2/2025, 3/2025 (3 th√°ng)
```

**V√≠ d·ª• 2:** Kh√°c nƒÉm
```
fromMonth: 11, toMonth: 2, fromYear: 2024, toYear: 2025
‚Üí T·∫°o: 11/2024, 12/2024, 1/2025, 2/2025 (4 th√°ng)
```

**V√≠ d·ª• 3:** Nhi·ªÅu nƒÉm
```
fromMonth: 10, toMonth: 3, fromYear: 2024, toYear: 2026
‚Üí T·∫°o: 
  - 2024: 10, 11, 12 (3 th√°ng)
  - 2025: 1-12 (12 th√°ng)
  - 2026: 1, 2, 3 (3 th√°ng)
  T·ªïng: 18 th√°ng
```

### 3. **X·ª≠ l√Ω ph√≤ng c√≥/kh√¥ng c√≥ bu·ªìng**

#### Ph√≤ng KH√îNG c√≥ bu·ªìng (hasSubRooms = false):
- T·∫°o 1 schedule cho ph√≤ng ch√≠nh
- Sinh slots theo ca ƒë∆∞·ª£c ch·ªçn
- M·ªói slot = th·ªùi gian c·∫£ ca

#### Ph√≤ng C√ì bu·ªìng (hasSubRooms = true):
- T·∫°o schedule cho **T·∫§T C·∫¢** c√°c bu·ªìng (k·ªÉ c·∫£ inactive)
- Sinh slots CH·ªà cho c√°c bu·ªìng ƒë∆∞·ª£c ch·ªçn trong `selectedSubRoomIds`
- N·∫øu kh√¥ng c√≥ `selectedSubRoomIds` ‚Üí Sinh slots cho t·∫•t c·∫£ bu·ªìng active
- M·ªói slot = `config.unitDuration` (m·∫∑c ƒë·ªãnh 15 ph√∫t)

**Quan tr·ªçng:**
```javascript
// T·∫°o schedule: ALL subrooms (ƒë·ªÉ track tr·∫°ng th√°i)
allSubRoomIds = [subRoom1, subRoom2, subRoom3, ...]

// Sinh slots: CH·ªà subrooms ƒë∆∞·ª£c ch·ªçn
selectedSubRoomIds = [subRoom1, subRoom2]
‚Üí Ch·ªâ sinh slots cho subRoom1 v√† subRoom2
```

### 4. **X·ª≠ l√Ω tr∆∞·ªùng h·ª£p ƒë√£ c√≥ l·ªãch**

#### Tr∆∞·ªùng h·ª£p 1: L·ªãch ƒê√É T·ªíN T·∫†I + T·∫•t c·∫£ ca ƒë√£ ƒë∆∞·ª£c t·∫°o
```
Status: "skipped"
Message: "ƒê√£ c√≥ l·ªãch t·ª´ 01/01/2025 ƒë·∫øn 31/01/2025 (Ca S√°ng, Ca Chi·ªÅu, Ca T·ªëi)"
‚Üí B·ªè qua, kh√¥ng l√†m g√¨
```

#### Tr∆∞·ªùng h·ª£p 2: L·ªãch ƒê√É T·ªíN T·∫†I + Thi·∫øu m·ªôt s·ªë ca
```
V√≠ d·ª•: L·ªãch ƒë√£ c√≥ Ca S√°ng, user mu·ªën th√™m Ca Chi·ªÅu v√† Ca T·ªëi

Status: "updated"
Message: "ƒê√£ th√™m afternoon, evening v√†o l·ªãch hi·ªán c√≥"
‚Üí Th√™m slots cho c√°c ca c√≤n thi·∫øu
‚Üí C·∫≠p nh·∫≠t shiftConfig.isGenerated = true cho c√°c ca m·ªõi
```

#### Tr∆∞·ªùng h·ª£p 3: Ch∆∞a c√≥ l·ªãch
```
Status: "created"
‚Üí T·∫°o m·ªõi schedule
‚Üí Sinh slots cho c√°c ca ƒë∆∞·ª£c ch·ªçn
‚Üí Set shiftConfig.isGenerated = true cho c√°c ca ƒë∆∞·ª£c t·∫°o
```

### 5. **Snapshot Holiday**

Khi t·∫°o l·ªãch, h·ªá th·ªëng s·∫Ω:
- L·∫•y danh s√°ch ng√†y ngh·ªâ l·ªÖ trong kho·∫£ng th·ªùi gian
- L∆∞u v√†o `holidaySnapshot` c·ªßa schedule
- **KH√îNG sinh slots** cho c√°c ng√†y ngh·ªâ l·ªÖ
- Snapshot n√†y gi√∫p tracking ng√†y ngh·ªâ d√π sau n√†y config holiday c√≥ thay ƒë·ªïi

### 6. **Shift Config Snapshot**

M·ªói schedule l∆∞u snapshot c·ªßa 3 ca:

```javascript
shiftConfig: {
  morning: {
    name: "Ca S√°ng",
    startTime: "08:00",
    endTime: "12:00",
    slotDuration: 15,
    isActive: true,        // Tr·∫°ng th√°i ca t·∫°i th·ªùi ƒëi·ªÉm t·∫°o
    isGenerated: true      // ƒê√£ sinh slots cho ca n√†y ch∆∞a
  },
  afternoon: { ... },
  evening: { ... }
}
```

**isGenerated vs isActive:**
- `isActive`: Tr·∫°ng th√°i t·ª´ config (ca c√≥ ƒëang ho·∫°t ƒë·ªông kh√¥ng)
- `isGenerated`: Ca n√†y ƒë√£ ƒë∆∞·ª£c t·∫°o slots ch∆∞a
- C√≥ th·ªÉ c√≥: `isActive=false` + `isGenerated=true` (ca ƒë√£ t·∫°o nh∆∞ng sau ƒë√≥ b·ªã t·∫Øt)

---

## üìä Use Cases

### Use Case 1: T·∫°o l·ªãch m·ªõi cho ph√≤ng ƒë∆°n gi·∫£n

**Request:**
```json
{
  "roomId": "room_123",
  "fromMonth": 1,
  "toMonth": 3,
  "fromYear": 2025,
  "toYear": 2025,
  "startDate": "2025-01-01T00:00:00.000Z",
  "shifts": ["morning", "afternoon", "evening"]
}
```

**K·∫øt qu·∫£:**
- T·∫°o 3 schedules (th√°ng 1, 2, 3 nƒÉm 2025)
- M·ªói schedule c√≥ slots cho 3 ca
- T·ªïng slots: ~720 slots (3 th√°ng √ó 3 ca √ó ~80 slots/ca)

---

### Use Case 2: T·∫°o l·ªãch cho ph√≤ng c√≥ nhi·ªÅu bu·ªìng

**Request:**
```json
{
  "roomId": "room_with_subrooms",
  "selectedSubRoomIds": ["subRoom1", "subRoom2"],
  "fromMonth": 1,
  "toMonth": 1,
  "fromYear": 2025,
  "toYear": 2025,
  "startDate": "2025-01-01T00:00:00.000Z",
  "shifts": ["morning", "afternoon"]
}
```

**K·∫øt qu·∫£:**
- T·∫°o schedules cho T·∫§T C·∫¢ bu·ªìng c·ªßa ph√≤ng (v√≠ d·ª•: 5 bu·ªìng)
- Sinh slots CH·ªà cho 2 bu·ªìng ƒë∆∞·ª£c ch·ªçn (subRoom1, subRoom2)
- M·ªói bu·ªìng ƒë∆∞·ª£c ch·ªçn c√≥ slots cho 2 ca (s√°ng, chi·ªÅu)
- C√°c bu·ªìng c√≤n l·∫°i c√≥ schedule nh∆∞ng kh√¥ng c√≥ slots (isGenerated=false)

**L√Ω do:** ƒê·ªÉ tracking tr·∫°ng th√°i c·ªßa t·∫•t c·∫£ bu·ªìng, d√π ch∆∞a t·∫°o slots

---

### Use Case 3: Th√™m ca thi·∫øu v√†o l·ªãch ƒë√£ c√≥

**T√¨nh hu·ªëng:**
- Th√°ng 1/2025 ƒë√£ c√≥ l·ªãch Ca S√°ng
- Mu·ªën th√™m Ca Chi·ªÅu v√† Ca T·ªëi t·ª´ ng√†y 15/01/2025

**Request:**
```json
{
  "roomId": "room_123",
  "fromMonth": 1,
  "toMonth": 1,
  "fromYear": 2025,
  "toYear": 2025,
  "startDate": "2025-01-01T00:00:00.000Z",
  "partialStartDate": "2025-01-15T00:00:00.000Z",
  "shifts": ["afternoon", "evening"]
}
```

**K·∫øt qu·∫£:**
- Ph√°t hi·ªán l·ªãch th√°ng 1 ƒë√£ t·ªìn t·∫°i
- Ch·ªâ sinh slots cho Ca Chi·ªÅu v√† Ca T·ªëi
- CH·ªà t·∫°o slots t·ª´ 15/01 ƒë·∫øn 31/01 (kh√¥ng t·∫°o t·ª´ ƒë·∫ßu th√°ng)
- C·∫≠p nh·∫≠t `shiftConfig.afternoon.isGenerated = true`
- C·∫≠p nh·∫≠t `shiftConfig.evening.isGenerated = true`

---

### Use Case 4: T·∫°o l·ªãch nhi·ªÅu th√°ng (cross-year)

**Request:**
```json
{
  "roomId": "room_123",
  "fromMonth": 11,
  "toMonth": 2,
  "fromYear": 2024,
  "toYear": 2025,
  "startDate": "2024-11-01T00:00:00.000Z",
  "shifts": ["morning", "afternoon", "evening"]
}
```

**K·∫øt qu·∫£:**
- T·∫°o 4 schedules:
  - 11/2024 (t·ª´ 01/11 ƒë·∫øn 30/11)
  - 12/2024 (t·ª´ 01/12 ƒë·∫øn 31/12)
  - 01/2025 (t·ª´ 01/01 ƒë·∫øn 31/01)
  - 02/2025 (t·ª´ 01/02 ƒë·∫øn 28/02)
- M·ªói schedule c√≥ slots cho 3 ca
- X·ª≠ l√Ω ng√†y ngh·ªâ T·∫øt (30/12-05/01) t·ª± ƒë·ªông

---

## ‚ö†Ô∏è Validation & Error Handling

### Error 400 - Bad Request:

```json
// Thi·∫øu th√¥ng tin
{
  "success": false,
  "message": "Thi·∫øu th√¥ng tin: roomId, fromMonth, toMonth, fromYear/toYear (ho·∫∑c year), startDate, v√† shifts l√† b·∫Øt bu·ªôc"
}

// Th√°ng kh√¥ng h·ª£p l·ªá
{
  "success": false,
  "message": "Th√°ng ph·∫£i t·ª´ 1-12"
}

// NƒÉm kh√¥ng h·ª£p l·ªá
{
  "success": false,
  "message": "NƒÉm k·∫øt th√∫c ph·∫£i >= NƒÉm b·∫Øt ƒë·∫ßu"
}

// Kh√¥ng ch·ªçn ca
{
  "success": false,
  "message": "Ph·∫£i ch·ªçn √≠t nh·∫•t 1 ca ƒë·ªÉ t·∫°o l·ªãch"
}

// Ca kh√¥ng h·ª£p l·ªá
{
  "success": false,
  "message": "Ca kh√¥ng h·ª£p l·ªá: night. Ch·ªâ ch·∫•p nh·∫≠n: morning, afternoon, evening"
}

// selectedSubRoomIds kh√¥ng h·ª£p l·ªá
{
  "success": false,
  "message": "selectedSubRoomIds ph·∫£i l√† m·∫£ng"
}

// Kh√¥ng ch·ªçn bu·ªìng
{
  "success": false,
  "message": "Ph·∫£i ch·ªçn √≠t nh·∫•t 1 bu·ªìng ƒë·ªÉ t·∫°o l·ªãch"
}

// partialStartDate kh√¥ng h·ª£p l·ªá
{
  "success": false,
  "message": "Ng√†y b·∫Øt ƒë·∫ßu t·∫°o l·ªãch ph·∫£i sau ng√†y hi·ªán t·∫°i √≠t nh·∫•t 1 ng√†y"
}
```

### Error 403 - Forbidden:

```json
{
  "success": false,
  "message": "Ch·ªâ qu·∫£n l√Ω ho·∫∑c admin m·ªõi ƒë∆∞·ª£c ph√©p t·∫°o l·ªãch"
}
```

### Error 500 - Internal Server Error:

```json
{
  "success": false,
  "message": "Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh l·ªãch l√†m vi·ªác. Vui l√≤ng t·∫°o c·∫•u h√¨nh tr∆∞·ªõc."
}

{
  "success": false,
  "message": "Kh√¥ng t√¨m th·∫•y th√¥ng tin ph√≤ng room_123 trong cache"
}

{
  "success": false,
  "message": "Th·ªùi gian c·∫•u h√¨nh cho Ca S√°ng kh√¥ng h·ª£p l·ªá"
}
```

---

## üéØ Business Rules

### 1. **Quy t·∫Øc t·∫°o schedule cho ph√≤ng c√≥ bu·ªìng:**

```
‚úÖ LU√îN t·∫°o schedule cho T·∫§T C·∫¢ bu·ªìng
‚ùå KH√îNG sinh slots cho bu·ªìng kh√¥ng ƒë∆∞·ª£c ch·ªçn
‚Üí M·ª•c ƒë√≠ch: Tracking tr·∫°ng th√°i c·ªßa t·∫•t c·∫£ bu·ªìng
```

**V√≠ d·ª•:**
```
Room c√≥ 5 bu·ªìng: A, B, C, D, E
User ch·ªçn: B, C
‚Üí T·∫°o 5 schedules (A, B, C, D, E)
‚Üí Sinh slots CH·ªà cho B, C
‚Üí A, D, E: schedule.shiftConfig.*.isGenerated = false
```

### 2. **Quy t·∫Øc isActive vs isGenerated:**

```javascript
// CA ƒê√É T·∫†O nh∆∞ng sau ƒë√≥ B·ªä T·∫ÆT trong config
schedule.shiftConfig.morning = {
  isActive: false,      // Config hi·ªán t·∫°i: ca b·ªã t·∫Øt
  isGenerated: true     // L·ªãch s·ª≠: ca ƒë√£ t·ª´ng ƒë∆∞·ª£c t·∫°o
}
‚Üí Slots v·∫´n t·ªìn t·∫°i, c√≥ th·ªÉ booking

// CA CH∆ØA T·∫†O
schedule.shiftConfig.morning = {
  isActive: true,       // Config hi·ªán t·∫°i: ca ƒëang b·∫≠t
  isGenerated: false    // L·ªãch s·ª≠: ch∆∞a t·∫°o slots cho ca n√†y
}
‚Üí Kh√¥ng c√≥ slots, kh√¥ng th·ªÉ booking
```

### 3. **Quy t·∫Øc x·ª≠ l√Ω holiday:**

```
Ng√†y ngh·ªâ l·ªÖ:
‚Üí KH√îNG sinh slots
‚Üí L∆∞u v√†o holidaySnapshot ƒë·ªÉ tracking
‚Üí D√π sau n√†y holiday config thay ƒë·ªïi, schedule v·∫´n gi·ªØ snapshot

V√≠ d·ª•:
holidaySnapshot: [
  {
    date: "2025-01-01",
    name: "T·∫øt D∆∞∆°ng l·ªãch",
    type: "official"
  }
]
```

### 4. **Quy t·∫Øc partialStartDate:**

```
D√πng khi: Th√™m ca thi·∫øu v√†o l·ªãch ƒë√£ c√≥
Validate:
  ‚úÖ partialStartDate > today + 1 day
  ‚úÖ partialStartDate <= schedule.endDate

V√≠ d·ª•:
Schedule: 01/01 - 31/01
partialStartDate: 15/01
‚Üí Sinh slots CH·ªà t·ª´ 15/01 ƒë·∫øn 31/01
‚Üí Kh√¥ng t·∫°o l·∫°i slots t·ª´ 01/01 - 14/01
```

---

## üìà Performance & Optimization

### 1. **Redis Cache:**
```javascript
// L·∫•y th√¥ng tin room t·ª´ cache (fast)
const roomInfo = await getRoomByIdFromCache(roomId);

// Kh√¥ng c·∫ßn query DB m·ªói l·∫ßn
‚Üí Gi·∫£m DB load
‚Üí TƒÉng t·ªëc ƒë·ªô response
```

### 2. **Batch Processing:**
```javascript
// T·∫°o nhi·ªÅu th√°ng trong 1 request
fromMonth: 1, toMonth: 12
‚Üí T·∫°o 12 schedules trong 1 l·∫ßn
‚Üí Gi·∫£m s·ªë l∆∞·ª£ng API calls
```

### 3. **Skip Logic:**
```javascript
// Ph√°t hi·ªán l·ªãch ƒë√£ t·ªìn t·∫°i ‚Üí Skip
if (existingSchedule && allShiftsGenerated) {
  return { status: 'skipped' };
}
‚Üí Kh√¥ng t·∫°o duplicate
‚Üí Ti·∫øt ki·ªám DB operations
```

### 4. **Conflict Detection:**
```javascript
// Check overlap schedules
const overlappingSchedules = await Schedule.find({
  roomId,
  subRoomId,
  $or: [{ startDate: { $lte: end }, endDate: { $gte: start } }]
});
‚Üí Tr√°nh t·∫°o slots tr√πng l·∫∑p
```

---

## üîÑ Workflow

```
1. User ch·ªçn:
   - Ph√≤ng
   - Bu·ªìng (n·∫øu c√≥)
   - Kho·∫£ng th·ªùi gian (th√°ng/nƒÉm)
   - Ca l√†m vi·ªác
   - Ng√†y b·∫Øt ƒë·∫ßu (cho th√°ng ƒë·∫ßu)
   
2. Frontend g·ª≠i request ‚Üí

3. Backend validate:
   ‚úÖ Authorization (manager/admin)
   ‚úÖ Input data
   ‚úÖ Date ranges
   ‚úÖ Shifts valid
   
4. Backend t√≠nh to√°n:
   ‚Üí Danh s√°ch th√°ng c·∫ßn t·∫°o
   ‚Üí Danh s√°ch bu·ªìng c·∫ßn process
   ‚Üí Holiday snapshot
   
5. Duy·ªát t·ª´ng th√°ng:
   ‚Üí Check l·ªãch ƒë√£ t·ªìn t·∫°i?
     ‚Üí C√≥ + ƒë·∫ßy ƒë·ªß ca: Skip
     ‚Üí C√≥ + thi·∫øu ca: Update (th√™m ca)
     ‚Üí Ch∆∞a c√≥: Create new
   
6. T·∫°o schedule:
   ‚Üí L∆∞u shiftConfig snapshot
   ‚Üí L∆∞u holiday snapshot
   ‚Üí Set isGenerated cho ca ƒë∆∞·ª£c t·∫°o
   
7. Sinh slots:
   ‚Üí Duy·ªát t·ª´ng ng√†y (tr·ª´ ng√†y ngh·ªâ)
   ‚Üí T·∫°o slots theo unitDuration
   ‚Üí L∆∞u v√†o DB
   
8. Return response:
   ‚Üí T·ªïng s·ªë th√°ng t·∫°o
   ‚Üí T·ªïng s·ªë slots
   ‚Üí Chi ti·∫øt t·ª´ng th√°ng
```

---

## üìù Notes

### Backward Compatibility:
```javascript
// H·ªó tr·ª£ c·∫£ 2 c√°ch:
// C√°ch c≈© (deprecated)
{ year: 2025, fromMonth: 1, toMonth: 3 }

// C√°ch m·ªõi (recommended)
{ fromYear: 2025, toYear: 2025, fromMonth: 1, toMonth: 3 }
```

### SubRoom Selection:
```javascript
// Legacy: single subRoomId
{ subRoomId: "subRoom1" }

// New: multiple subRoomIds
{ selectedSubRoomIds: ["subRoom1", "subRoom2"] }

// No selection: all active subrooms
{ selectedSubRoomIds: null }
```

### Slot Duration:
```javascript
// Room WITHOUT subrooms:
slotDuration = shift duration
// V√≠ d·ª•: Ca S√°ng 08:00-12:00 ‚Üí 1 slot = 240 ph√∫t

// Room WITH subrooms:
slotDuration = config.unitDuration
// V√≠ d·ª•: config.unitDuration = 15 ‚Üí 1 slot = 15 ph√∫t
```

---

## üéì Best Practices

### 1. **T·∫°o l·ªãch theo batch:**
```javascript
// ‚úÖ GOOD: T·∫°o nhi·ªÅu th√°ng c√πng l√∫c
{
  fromMonth: 1,
  toMonth: 6,
  fromYear: 2025,
  toYear: 2025
}
‚Üí 1 API call = 6 th√°ng

// ‚ùå BAD: T·∫°o t·ª´ng th√°ng
for (month = 1; month <= 6; month++) {
  await createSchedule({ month });
}
‚Üí 6 API calls
```

### 2. **Ch·ªçn bu·ªìng c·ª• th·ªÉ:**
```javascript
// ‚úÖ GOOD: Ch·ªâ t·∫°o cho bu·ªìng c·∫ßn d√πng
{
  selectedSubRoomIds: ["subRoom1", "subRoom2"]
}
‚Üí Ti·∫øt ki·ªám slots, nhanh h∆°n

// ‚ùå BAD: T·∫°o cho t·∫•t c·∫£
{
  selectedSubRoomIds: null
}
‚Üí T·∫°o nhi·ªÅu slots kh√¥ng c·∫ßn thi·∫øt
```

### 3. **S·ª≠ d·ª•ng partialStartDate:**
```javascript
// ‚úÖ GOOD: Ch·ªâ th√™m ca t·ª´ ng√†y c·ª• th·ªÉ
{
  partialStartDate: "2025-01-15",
  shifts: ["evening"]
}
‚Üí Ch·ªâ t·∫°o t·ª´ 15/01, kh√¥ng override slots c≈©

// ‚ùå BAD: Kh√¥ng d√πng partialStartDate
‚Üí C√≥ th·ªÉ t·∫°o duplicate ho·∫∑c b·ªã skip
```

---

## üêõ Troubleshooting

### Problem 1: "Schedule already exists with all requested shifts"

**Nguy√™n nh√¢n:**
- L·ªãch th√°ng n√†y ƒë√£ c√≥ ƒë·∫ßy ƒë·ªß c√°c ca ƒë∆∞·ª£c y√™u c·∫ßu

**Gi·∫£i ph√°p:**
- Ki·ªÉm tra l·∫°i l·ªãch hi·ªán t·∫°i
- N·∫øu mu·ªën t·∫°o l·∫°i: X√≥a l·ªãch c≈© tr∆∞·ªõc
- N·∫øu mu·ªën th√™m ca kh√°c: Ch·ªçn ca kh√°c trong `shifts`

---

### Problem 2: "Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh l·ªãch l√†m vi·ªác"

**Nguy√™n nh√¢n:**
- Ch∆∞a t·∫°o Schedule Config

**Gi·∫£i ph√°p:**
1. V√†o Settings ‚Üí Schedule Configuration
2. T·∫°o config v·ªõi:
   - Morning shift time
   - Afternoon shift time
   - Evening shift time
   - Unit duration (for subrooms)
3. L∆∞u config
4. Th·ª≠ l·∫°i API

---

### Problem 3: Slots kh√¥ng ƒë∆∞·ª£c t·∫°o cho bu·ªìng

**Nguy√™n nh√¢n:**
- Bu·ªìng kh√¥ng n·∫±m trong `selectedSubRoomIds`
- Ho·∫∑c bu·ªìng inactive + kh√¥ng ƒë∆∞·ª£c ch·ªçn

**Gi·∫£i ph√°p:**
```javascript
// Ki·ªÉm tra response:
{
  "status": "created",
  "scheduleId": "...",
  "totalSlots": 0  // ‚Üê No slots generated
}

// Th√™m bu·ªìng v√†o selectedSubRoomIds:
{
  "selectedSubRoomIds": ["subRoom1", "subRoom2", "subRoom3"]
}
```

---

### Problem 4: "Ng√†y b·∫Øt ƒë·∫ßu t·∫°o l·ªãch ph·∫£i sau ng√†y hi·ªán t·∫°i"

**Nguy√™n nh√¢n:**
- `partialStartDate` <= today

**Gi·∫£i ph√°p:**
```javascript
// ‚ùå Wrong
{
  "partialStartDate": "2025-01-10"  // today = 2025-01-10
}

// ‚úÖ Correct
{
  "partialStartDate": "2025-01-11"  // tomorrow
}
```

---

## üìö Related APIs

### Li√™n quan ƒë·∫øn Schedule:
```
GET  /api/schedules                    - List schedules
GET  /api/schedules/room/:roomId       - Get schedules by room
GET  /api/schedules/:scheduleId        - Get schedule detail
PUT  /api/schedules/:scheduleId        - Update schedule
POST /api/schedules/add-missing-shifts - Add missing shifts
```

### Li√™n quan ƒë·∫øn Configuration:
```
GET  /api/config                       - Get schedule config
POST /api/config                       - Create config
PUT  /api/config                       - Update config
```

### Li√™n quan ƒë·∫øn Holiday:
```
GET  /api/schedules/holiday-preview    - Preview holidays
GET  /api/holidays                     - List holidays
```

---

## üéâ Summary

API `generateRoomSchedule` l√† m·ªôt API m·∫°nh m·∫Ω v√† linh ho·∫°t cho vi·ªác:

‚úÖ **T·∫°o l·ªãch nhi·ªÅu th√°ng** (cross-year support)
‚úÖ **H·ªó tr·ª£ ph√≤ng c√≥/kh√¥ng c√≥ bu·ªìng**
‚úÖ **Ch·ªçn ca linh ho·∫°t** (morning, afternoon, evening)
‚úÖ **Th√™m ca thi·∫øu** v√†o l·ªãch ƒë√£ c√≥ (partial scheduling)
‚úÖ **T·ª± ƒë·ªông x·ª≠ l√Ω ng√†y ngh·ªâ** (holiday snapshot)
‚úÖ **Tracking tr·∫°ng th√°i** (isActive, isGenerated)
‚úÖ **Skip duplicate** (intelligent conflict detection)
‚úÖ **Performance optimized** (Redis cache, batch processing)

**Use this API when:**
- üìÖ T·∫°o l·ªãch l√†m vi·ªác m·ªõi
- üìù Th√™m ca thi·∫øu v√†o l·ªãch ƒë√£ c√≥
- üîÑ T·∫°o l·ªãch cho nhi·ªÅu th√°ng c√πng l√∫c
- üè• Qu·∫£n l√Ω l·ªãch ph√≤ng c√≥ nhi·ªÅu bu·ªìng

---

**T√†i li·ªáu ƒë∆∞·ª£c t·∫°o:** October 18, 2025  
**API Version:** 1.0.0  
**Status:** ‚úÖ Production Ready
