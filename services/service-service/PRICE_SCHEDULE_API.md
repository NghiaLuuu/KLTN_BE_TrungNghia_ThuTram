# üìã Price Schedule Management API Documentation

## Overview
H·ªá th·ªëng qu·∫£n l√Ω gi√° theo kho·∫£ng th·ªùi gian cho Service v√† ServiceAddOn.

### Features
- ‚úÖ **ServiceAddOn**: H·ªó tr·ª£ nhi·ªÅu `priceSchedules` (m·∫£ng)
- ‚úÖ **Service**: H·ªó tr·ª£ `temporaryPrice` (3 tr∆∞·ªùng ƒë∆°n gi·∫£n)
- ‚úÖ **Auto-calculate**: T·ª± ƒë·ªông t√≠nh gi√° hi·ªáu l·ª±c d·ª±a tr√™n ng√†y hi·ªán t·∫°i
- ‚úÖ **Date validation**: Validate `endDate` > `startDate`
- ‚úÖ **Optional on CREATE**: Kh√¥ng b·∫Øt bu·ªôc khi t·∫°o m·ªõi
- ‚úÖ **Flexible on UPDATE**: C√≥ th·ªÉ th√™m/s·ª≠a/x√≥a b·∫•t k·ª≥ l√∫c n√†o

---

## üìä Data Structure

### Service Model
```javascript
{
  name: String,
  type: 'exam' | 'treatment',
  description: String,
  requireExamFirst: Boolean,
  allowedRoomTypes: [String],
  serviceAddOns: [ServiceAddOn],
  isActive: Boolean,
  hasBeenUsed: Boolean,
  
  // üÜï Temporary Price Fields
  temporaryPrice: Number,      // Gi√° t·∫°m th·ªùi (null n·∫øu kh√¥ng c√≥)
  startDate: Date,             // Ng√†y b·∫Øt ƒë·∫ßu √°p d·ª•ng
  endDate: Date,               // Ng√†y k·∫øt th√∫c √°p d·ª•ng
  
  // üÜï Virtual Fields (auto-calculated)
  hasActiveTemporaryPrice: Boolean  // C√≥ gi√° t·∫°m th·ªùi ƒëang active kh√¥ng
}
```

### ServiceAddOn Model
```javascript
{
  name: String,
  price: Number,               // Gi√° g·ªëc
  durationMinutes: Number,
  unit: String,
  imageUrl: String,
  description: String,
  isActive: Boolean,
  hasBeenUsed: Boolean,
  
  // üÜï Price Schedules Array
  priceSchedules: [
    {
      _id: ObjectId,
      price: Number,           // Gi√° √°p d·ª•ng trong kho·∫£ng th·ªùi gian
      startDate: Date,         // Ng√†y b·∫Øt ƒë·∫ßu
      endDate: Date,           // Ng√†y k·∫øt th√∫c
      isActive: Boolean,       // C√≥ active kh√¥ng
      note: String,            // Ghi ch√∫
      createdAt: Date,
      updatedAt: Date
    }
  ],
  
  // üÜï Virtual Fields (in response)
  basePrice: Number,           // Gi√° g·ªëc
  effectivePrice: Number,      // Gi√° hi·ªáu l·ª±c (scheduled ho·∫∑c base)
  isPriceModified: Boolean     // Gi√° c√≥ b·ªã thay ƒë·ªïi kh√¥ng
}
```

---

## üîå API Endpoints

### 1. ServiceAddOn Price Schedules

#### **POST** `/api/services/:serviceId/addons/:addOnId/price-schedules`
Th√™m l·ªãch gi√° m·ªõi cho ServiceAddOn

**Request Body:**
```json
{
  "price": 150000,
  "startDate": "2024-01-01T00:00:00.000Z",
  "endDate": "2024-01-31T23:59:59.999Z",
  "isActive": true,
  "note": "Gi√° khuy·∫øn m√£i T·∫øt"
}
```

**Response:** Service object v·ªõi serviceAddOns updated

**Errors:**
- `400`: Validation error (endDate <= startDate)
- `403`: Unauthorized (kh√¥ng ph·∫£i manager/admin)
- `404`: Service ho·∫∑c AddOn kh√¥ng t·ªìn t·∫°i

---

#### **PUT** `/api/services/:serviceId/addons/:addOnId/price-schedules/:scheduleId`
C·∫≠p nh·∫≠t l·ªãch gi√°

**Request Body:** (t·∫•t c·∫£ optional)
```json
{
  "price": 160000,
  "startDate": "2024-01-01T00:00:00.000Z",
  "endDate": "2024-02-28T23:59:59.999Z",
  "isActive": false,
  "note": "Gia h·∫°n th√™m 1 th√°ng"
}
```

**Response:** Service object updated

---

#### **DELETE** `/api/services/:serviceId/addons/:addOnId/price-schedules/:scheduleId`
X√≥a l·ªãch gi√°

**Response:**
```json
{
  "message": "ƒê√£ x√≥a l·ªãch gi√° th√†nh c√¥ng"
}
```

---

#### **PATCH** `/api/services/:serviceId/addons/:addOnId/price-schedules/:scheduleId/toggle`
B·∫≠t/t·∫Øt tr·∫°ng th√°i active c·ªßa l·ªãch gi√°

**Response:** Service object v·ªõi schedule.isActive toggled

---

### 2. Service Temporary Price

#### **PUT** `/api/services/:serviceId/temporary-price`
C·∫≠p nh·∫≠t gi√° t·∫°m th·ªùi cho Service

**Request Body:** (t·∫•t c·∫£ optional)
```json
{
  "temporaryPrice": 200000,
  "startDate": "2024-01-01T00:00:00.000Z",
  "endDate": "2024-01-31T23:59:59.999Z"
}
```

**Response:** Service object updated

**Use Cases:**
- Set t·∫•t c·∫£ 3 fields: √Åp d·ª•ng gi√° t·∫°m th·ªùi v·ªõi kho·∫£ng th·ªùi gian
- Set ch·ªâ `temporaryPrice`: √Åp d·ª•ng gi√° t·∫°m th·ªùi v√¥ th·ªùi h·∫°n
- Update t·ª´ng field ri√™ng l·∫ª

---

#### **DELETE** `/api/services/:serviceId/temporary-price`
X√≥a gi√° t·∫°m th·ªùi (reset v·ªÅ null)

**Response:**
```json
{
  "message": "ƒê√£ x√≥a gi√° t·∫°m th·ªùi th√†nh c√¥ng"
}
```

---

### 3. List/Get Services (Enhanced)

#### **GET** `/api/services`
List t·∫•t c·∫£ services v·ªõi effective prices

**Response:**
```json
{
  "total": 50,
  "page": 1,
  "limit": 10,
  "totalPages": 5,
  "services": [
    {
      "_id": "...",
      "name": "Nh·ªï rƒÉng kh√¥n",
      "hasActiveTemporaryPrice": false,
      "temporaryPrice": null,
      "startDate": null,
      "endDate": null,
      "serviceAddOns": [
        {
          "_id": "...",
          "name": "Nh·ªï rƒÉng kh√¥n ƒë∆°n gi·∫£n",
          "price": 500000,
          "basePrice": 500000,
          "effectivePrice": 450000,
          "isPriceModified": true,
          "priceSchedules": [
            {
              "_id": "...",
              "price": 450000,
              "startDate": "2024-01-01T00:00:00.000Z",
              "endDate": "2024-01-31T23:59:59.999Z",
              "isActive": true,
              "note": "Gi√° khuy·∫øn m√£i T·∫øt"
            }
          ]
        }
      ]
    }
  ]
}
```

---

#### **GET** `/api/services/:id`
Get service by ID v·ªõi effective prices

**Response:** Service object nh∆∞ tr√™n v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin

---

## üßÆ Effective Price Calculation Logic

### ServiceAddOn
```javascript
// Priority: Active PriceSchedule > Base Price
1. T√¨m priceSchedule active v·ªõi:
   - isActive === true
   - currentDate >= startDate
   - currentDate <= endDate
2. N·∫øu c√≥: return schedule.price
3. N·∫øu kh√¥ng: return addOn.price (gi√° g·ªëc)
```

### Service Temporary Price
```javascript
// Check if temporary price is active
hasActiveTemporaryPrice() {
  return temporaryPrice !== null &&
         startDate !== null &&
         endDate !== null &&
         currentDate >= startDate &&
         currentDate <= endDate
}
```

---

## üìù Usage Examples

### Example 1: Th√™m gi√° khuy·∫øn m√£i T·∫øt
```javascript
// POST /api/services/64a1b2c3.../addons/64b2c3d4.../price-schedules
{
  "price": 450000,
  "startDate": "2024-01-20T00:00:00.000Z",
  "endDate": "2024-02-10T23:59:59.999Z",
  "isActive": true,
  "note": "Khuy·∫øn m√£i T·∫øt Nguy√™n ƒê√°n 2024"
}
```

### Example 2: Set gi√° t·∫°m th·ªùi cho Service (√°p d·ª•ng t·∫•t c·∫£ add-ons)
```javascript
// PUT /api/services/64a1b2c3.../temporary-price
{
  "temporaryPrice": 200000,
  "startDate": "2024-03-01T00:00:00.000Z",
  "endDate": "2024-03-31T23:59:59.999Z"
}
```

### Example 3: T·∫Øt l·ªãch gi√° t·∫°m th·ªùi
```javascript
// PATCH /api/services/64a1b2c3.../addons/64b2c3d4.../price-schedules/64c3d4e5.../toggle
// Response: schedule.isActive toggled
```

### Example 4: X√≥a gi√° t·∫°m th·ªùi c·ªßa Service
```javascript
// DELETE /api/services/64a1b2c3.../temporary-price
// Response: temporaryPrice, startDate, endDate ‚Üí null
```

---

## üîê Authorization

**T·∫•t c·∫£ c√°c endpoint thay ƒë·ªïi gi√° y√™u c·∫ßu:**
- Role: `manager` ho·∫∑c `admin`
- Header: `Authorization: Bearer <token>`

**Endpoint public (GET only):**
- `GET /api/services` - List services with effective prices
- `GET /api/services/:id` - Get service detail with effective prices

---

## ‚ö†Ô∏è Validation Rules

1. **Date Range:**
   - `endDate` ph·∫£i > `startDate`
   - T·ª± ƒë·ªông validate trong schema

2. **Price:**
   - Ph·∫£i >= 0
   - Required khi th√™m m·ªõi priceSchedule

3. **Active Status:**
   - Default: `true`
   - C√≥ th·ªÉ toggle b·∫•t k·ª≥ l√∫c n√†o

4. **Note:**
   - Optional
   - Max length: 500 characters

---

## üéØ Best Practices

### 1. Multiple Price Schedules
```javascript
// ServiceAddOn c√≥ th·ªÉ c√≥ nhi·ªÅu schedules
// H·ªá th·ªëng t·ª± ƒë·ªông ch·ªçn schedule active v·ªõi currentDate
priceSchedules: [
  {
    price: 450000,
    startDate: "2024-01-01",
    endDate: "2024-01-31",
    isActive: true,
    note: "Th√°ng 1"
  },
  {
    price: 480000,
    startDate: "2024-02-01",
    endDate: "2024-02-28",
    isActive: true,
    note: "Th√°ng 2"
  }
]
```

### 2. Temporary Price vs Price Schedule
- **Temporary Price**: √Åp d·ª•ng cho to√†n b·ªô Service (hi·∫øm khi d√πng)
- **Price Schedule**: √Åp d·ª•ng ri√™ng cho t·ª´ng ServiceAddOn (recommended)

### 3. Deactivate Instead of Delete
```javascript
// Thay v√¨ x√≥a, n√™n toggle isActive = false
// PATCH /api/services/:serviceId/addons/:addOnId/price-schedules/:scheduleId/toggle
```

### 4. Future Schedules
```javascript
// C√≥ th·ªÉ t·∫°o l·ªãch gi√° t∆∞∆°ng lai
{
  price: 500000,
  startDate: "2024-06-01",  // T∆∞∆°ng lai
  endDate: "2024-06-30",
  isActive: true,
  note: "Gi√° m√πa h√®"
}
// S·∫Ω t·ª± ƒë·ªông active khi ƒë·∫øn ng√†y
```

---

## üîÑ Migration Notes

**Existing Services:**
- Kh√¥ng c·∫ßn migration
- C√°c field m·ªõi l√† optional
- Gi√° g·ªëc (`price`) v·∫´n ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng

**Backward Compatible:**
- ‚úÖ GET APIs tr·∫£ v·ªÅ th√™m `effectivePrice`
- ‚úÖ Kh√¥ng breaking existing clients
- ‚úÖ Frontend c√≥ th·ªÉ check `isPriceModified` ƒë·ªÉ hi·ªÉn th·ªã badge

---

## üìä Frontend Display Recommendations

### ServiceList.jsx
```javascript
{service.serviceAddOns.map(addOn => (
  <div>
    <span>{addOn.name}</span>
    {addOn.isPriceModified ? (
      <>
        <span className="original-price">{addOn.basePrice.toLocaleString()}ƒë</span>
        <span className="effective-price">{addOn.effectivePrice.toLocaleString()}ƒë</span>
        <Tag color="red">Khuy·∫øn m√£i</Tag>
      </>
    ) : (
      <span>{addOn.price.toLocaleString()}ƒë</span>
    )}
  </div>
))}
```

### ServiceDetails.jsx
- Add section "Qu·∫£n l√Ω l·ªãch gi√°"
- Table hi·ªÉn th·ªã `priceSchedules` v·ªõi actions (Edit/Delete/Toggle)
- Form ƒë·ªÉ th√™m/s·ª≠a price schedule
- Date range picker
- Active/Inactive badge

---

## üß™ Testing Checklist

- [ ] T·∫°o service m·ªõi kh√¥ng c√≥ price schedule (optional fields)
- [ ] Th√™m price schedule cho ServiceAddOn
- [ ] Update price schedule
- [ ] Toggle active/inactive
- [ ] Delete price schedule
- [ ] Set temporary price cho Service
- [ ] Remove temporary price
- [ ] GET services tr·∫£ v·ªÅ effectivePrice ƒë√∫ng
- [ ] Validate endDate > startDate
- [ ] Authorization check (403 n·∫øu kh√¥ng ph·∫£i manager/admin)
- [ ] Multiple overlapping schedules (ch·ªçn ƒë√∫ng theo date)

---

## üìö Related Files

**Backend:**
- `models/service.model.js` - Schema definitions & methods
- `services/service.service.js` - Business logic
- `controllers/service.controller.js` - HTTP handlers
- `routes/service.route.js` - Route definitions

**Frontend (TODO):**
- `services/servicesService.js` - API client methods
- `pages/ServiceList.jsx` - Display effective prices
- `pages/ServiceDetails.jsx` - Manage price schedules

---

## üéâ Summary

H·ªá th·ªëng Price Schedule Management cung c·∫•p:
‚úÖ Flexible pricing v·ªõi date ranges
‚úÖ Multiple schedules per ServiceAddOn
‚úÖ Simple temporary price for Service
‚úÖ Auto-calculate effective prices
‚úÖ Backward compatible
‚úÖ Manager/Admin only access
‚úÖ Easy to extend

**Next Steps:**
1. ‚úÖ Backend implementation (DONE)
2. ‚è≥ Frontend API service methods
3. ‚è≥ Frontend UI components
4. ‚è≥ Testing & validation
