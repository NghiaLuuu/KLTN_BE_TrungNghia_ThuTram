name: Deploy to Production Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Cho phÃ©p trigger manual

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 194.233.75.21 >> ~/.ssh/known_hosts
      
      - name: Deploy Application
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh -i ~/.ssh/id_rsa $SERVER_USER@$SERVER_HOST << 'EOF'
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to project directory
            cd ~/dental-clinic || {
              echo "Project directory not found. Cloning repository..."
              cd ~
              git clone https://github.com/${{ github.repository }}.git dental-clinic
              cd dental-clinic
            }
            
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            git pull origin main
            
            echo "ðŸ³ Building and starting Docker containers..."
            cd docker
            
            # Stop existing containers
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
            
            # Build new images
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache
            
            # Start containers
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker system prune -f
            
            echo "ðŸ”§ Updating Nginx configuration..."
            cd ~/dental-clinic
            if [ -f nginx/setup-nginx.sh ]; then
              chmod +x nginx/setup-nginx.sh
              ./nginx/setup-nginx.sh
            fi
            
            echo "âœ… Deployment completed!"
          EOF
      
      - name: Health Check
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          echo "â³ Waiting 60 seconds for services to start..."
          sleep 60
          
          ssh -i ~/.ssh/id_rsa $SERVER_USER@$SERVER_HOST << 'EOF'
            echo "ðŸ©º Running health checks..."
            
            # Check if containers are running
            running=$(docker ps --filter "name=dental_" --format "{{.Names}}" | wc -l)
            echo "ðŸ“Š Running containers: $running"
            
            if [ $running -lt 10 ]; then
              echo "âŒ Not enough services running (expected at least 10)"
              docker ps -a
              exit 1
            fi
            
            echo "âœ… All services are running!"
          EOF
      
      - name: Show Deployment Info
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ðŸ“Š Server: ${{ secrets.SERVER_HOST }}"
          echo "ðŸ‘¤ User: ${{ secrets.SERVER_USER }}"
          echo "ðŸŒ Check your application at: http://${{ secrets.SERVER_HOST }}"

